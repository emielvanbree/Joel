<!doctype html>
<html lang="nl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Autoflower Grow Assistant</title>
    <style>
        /*
         * Kleurenpalet Groeicyclus Cannabis
         * Aarde Bruin: #4D3A31 (fg/dark-fg)
         * Vegetatieve Groen: #38761D (main-text/dark-main-text)
         * Limoen Groen: #A9C439 (cta)
         * Zaailing Groen: #90B47A (muted/line)
         * Licht Grijs: #F5F5F5 (bg/pill)
         */
        :root{
            /* Light Mode */
            --bg: #F5F5F5;
            --fg: #4D3A31; /* Hoofdtitels/Headers - Aarde Bruin */
            --main-text: #38761D; /* Body Tekst - Vegetatieve Groen */
            --muted: #90B47A; /* Secundaire Tekst - Zaailing Groen */
            --card: #FFFFFF;
            --line: #90B47A; /* Randen/Lijnen - Zaailing Groen */
            --pill: #F5F5F5; /* Tabs/Pills Achtergrond - Licht Grijs */
            --cta: #A9C439; /* Primaire Knoppen - Limoen Groen */
            --cta-hover: #7D932A; /* Limoen Groen - Donkerder */
            --danger: #CC0000; /* Fouten/Verwijderen */
            --radius: 18px;
        }

        /* Dark Mode */
        .dark {
            --bg: #1A1A1A; /* Dark background */
            --fg: #F5F5F5; /* Light text (titles) */
            --main-text: #A9C439; /* Body text (Limoen Groen) */
            --muted: #90B47A; /* Muted green */
            --card: #282828; /* Dark card background */
            --line: #3A3A3A; /* Darker borders */
            --pill: #212121; /* Pill/Tab background */
            --cta: #A9C439; 
            --cta-hover: #C5E358; 
            --danger: #FF6666; 
            color: var(--main-text);
        }

        /* Basis en Typografie */
        *{box-sizing:border-box}
        body{
            margin:0;
            font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
            background:var(--bg);
            color:var(--main-text); 
            transition: background 0.3s, color 0.3s;
        }
        h1{font-size:24px; margin:0; font-weight:700; color:var(--fg); transition: color 0.3s;} 
        .section-title{font-weight:600; margin:16px 0 8px; color:var(--fg)}
        .hint{font-size:12px; color:var(--muted)}

        /* Dark Mode Specifieke Stijlen */
        .dark .header-content h1 { color: var(--fg); }
        .dark header { background: rgba(26, 26, 26, .9); border-bottom-color: var(--line); }
        .dark .empty { background: var(--card); border-color: var(--line); }

        /* Header (Sticky & Mobiel Vriendelijk) */
        header{
            position:sticky;
            top:0;
            z-index:10;
            background:rgba(245, 245, 245, .9); 
            backdrop-filter:saturate(1.2) blur(6px);
            border-bottom:1px solid var(--line);
            transition: background 0.3s, border-bottom-color 0.3s;
        }
        .container{max-width:1080px; margin:0 auto; padding:12px 16px} 
        .header-content{
            display:flex;
            flex-wrap: wrap; 
            gap: 12px 8px; 
            align-items:center;
            padding: 8px 0;
        }
        
        .header-content h1{flex-basis: 100%; font-size: 20px;}
        .header-actions{
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-left:auto;
        }
        @media (min-width: 600px){ 
            .header-content h1{flex-basis: auto;}
            .header-actions{margin-left:auto; flex-grow:1; justify-content: flex-end;}
        }

        /* Knoppen & Formulieren */
        button, .btn, .tab.active{
            appearance:none;
            border:1px solid var(--line);
            padding:8px 12px;
            border-radius:16px;
            box-shadow:0 1px 0 rgba(0,0,0,.04);
            cursor: pointer;
            font-size: 14px;
            color: var(--fg);
            background: #fff;
            transition: background 0.2s, border-color 0.2s, color 0.2s;
        }
        
        /* Dark Mode Knoppen */
        .dark button, .dark .btn, .dark .tab { 
            background: var(--card); 
            border-color: var(--line); 
            color: var(--main-text); 
        }
        .dark button:hover, .dark .btn:hover { background: #333; color: var(--fg); }

        /* Primaire CTA knoppen */
        #btnAdd, #btnAdd2{
            background:var(--cta); 
            border-color: var(--cta);
            color: #fff;
            font-weight: 600;
        }
        #btnAdd:hover, #btnAdd2:hover{
            background:var(--cta-hover);
            border-color: var(--cta-hover);
        }

        /* Input Velden */
        input[type="date"], input[type="number"], input[type="text"], textarea, select{
            border:1px solid var(--line);
            border-radius:10px;
            padding:6px 10px;
            color: var(--main-text);
            background: #fff;
            transition: background 0.3s, color 0.3s, border-color 0.3s;
        }
        /* Dark Mode Input Velden */
        .dark input[type="date"], .dark input[type="number"], .dark input[type="text"], .dark textarea, .dark select {
            background: #333;
            color: var(--fg);
            border-color: #555;
        }
        
        /* Dark Mode Tabs */
        .dark .tab.active { 
            background: var(--pill); 
            border-color: var(--line); 
            color: var(--fg); 
        }

        /* Overige Layout Stijlen (ongewijzigd) */
        .field-group{ display: flex; align-items: center; gap: 6px; margin-bottom: 6px; font-size: 14px; color: var(--main-text); }
        .field-group input[type="number"] { width: 64px; text-align: center; }
        main.container{padding:20px 16px 40px}
        .grid{display:grid; grid-template-columns:1fr; gap:20px}
        @media (min-width:700px){ .grid{grid-template-columns:1fr 1fr} } 
        .card{background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:0 2px 4px rgba(0,0,0,.05); overflow:hidden; transition: background 0.3s, border-color 0.3s;}
        .card-h{ padding:14px; display:flex; flex-direction: column; gap: 12px; align-items:flex-start;}
        .row-name{ display: flex; gap: 8px; width: 100%; }
        .row-name input{flex: 1; border:none; outline:none; font-size:16px; font-weight:600;}
        .row-strain{ display: flex; gap: 8px; align-items: center; }
        .row-strain select { max-width: 250px; }
        .row-info{ display: flex; flex-wrap: wrap; gap: 8px 12px; align-items: center; font-size: 13px; color: var(--muted); width: 100%; }
        .row-info label{ display: flex; gap: 6px; align-items: center; }
        .row-info span:not(.pill) { white-space: nowrap; } 
        .row-info .action-buttons { margin-left: auto; display: flex; gap: 8px; }
        @media (max-width: 600px) { .row-info .action-buttons { margin-left: 0; flex-basis: 100%; justify-content: flex-start; } }
        .actions-bar { width: 100%; display: flex; flex-wrap: wrap; gap: 8px; border-bottom: 1px dashed var(--line); padding-bottom: 8px; }
        .action-item { background: #fff; border: 2px solid var(--cta); color: var(--cta); font-weight: 600; padding: 4px 10px; border-radius: 12px; cursor: pointer; box-shadow: 0 1px 2px rgba(0,0,0,.08); transition: background .2s; }
        .action-item:hover { background: rgba(169, 196, 57, 0.1); }
        .dark .action-item { background: #333; }
        .dark .action-item:hover { background: rgba(169, 196, 57, 0.2); }
        .action-item.feed { border-color: #FFA500; color: #FFA500; }
        .action-item.flush { border-color: #00BFFF; color: #00BFFF; }
        .pill{font-size:12px; background:var(--pill); border:1px solid var(--line); color:var(--main-text); padding:2px 8px; border-radius:999px}
        .tabs{display:flex; gap:6px; background:var(--pill); border-radius:999px; padding:4px; margin-top: 8px; flex-basis: 100%;}
        @media (min-width: 500px){.tabs{flex-basis: auto; margin-top: 0;}} 
        .tab{font-size:13px; padding:6px 10px; border-radius:999px; border:1px solid transparent; background:transparent; color: var(--main-text);}
        .tab.active{background:#fff; border-color:var(--line); box-shadow:0 1px 0 rgba(0,0,0,.04); color: var(--fg); font-weight: 600;} 
        .card-b{border-top:1px solid var(--line); padding:14px}
        .uploader{display:flex; flex-wrap:wrap; gap:8px; padding:10px; background:var(--pill); border:1px solid var(--line); border-radius:14px; transition: background 0.3s, border-color 0.3s;}
        .uploader input[type="file"]{flex-basis: 100%;} 
        .uploader label, .uploader input[type="text"]{flex-shrink: 0;}
        .uploader button{margin-left: auto; background: var(--cta); border-color: var(--cta); color: #fff;}
        .uploader button:hover{background: var(--cta-hover); border-color: var(--cta-hover);}
        figure{margin:0; border:1px solid var(--line); border-radius:14px; overflow:hidden; background:#fff}
        figure img{display:block; width:100%; height:auto; max-height:300px; object-fit:cover} 
        figcaption{padding:10px; display:flex; justify-content:space-between; gap:10px; font-size:14px; flex-wrap: wrap;}
        figcaption button{margin-top: 5px;}
        .muted{color:var(--muted)}
        .danger{color:var(--danger); border-color: var(--danger) !important;}
        .danger:hover{background: rgba(204, 0, 0, 0.1) !important;}
        .dark .danger:hover{background: rgba(255, 102, 102, 0.1) !important;}
        .empty{border:2px dashed var(--line); border-radius:var(--radius); padding:32px; text-align:center; background:#fff}
        .archived{opacity:.6}
        a{color: var(--cta);}

        /* Dark Mode Toggle Stijl */
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--cta);
        }
        input:checked + .slider:before {
            transform: translateX(20px);
        }
        .dark .slider { background-color: #555; }
        .dark input:checked + .slider { background-color: var(--cta-hover); }

    </style>
</head>
<body>
    <header>
        <div class="container header-content">
            <h1 id="appTitle">Autoflower Grow Assistant</h1>
            <div class="header-actions">
                <!-- Taal Selectie -->
                <select id="langSelect" style="border-radius: 16px; font-size: 14px; padding: 8px 10px;">
                    <option value="nl">Nederlands</option>
                    <option value="en">English</option>
                    <option value="de">Deutsch</option>
                    <option value="fr">FranÃ§ais</option>
                    <option value="es">EspaÃ±ol</option>
                </select>
                
                <!-- Dark Mode Toggle -->
                <div class="toggle-container">
                    <label id="darkModeLabel">Dark Mode</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="darkModeToggle">
                        <span class="slider"></span>
                    </label>
                </div>

                <button id="btnAdd" data-i18n="newPlant">+ Nieuwe plant</button>
                <button id="btnExport" data-i18n="export">Export</button>
                <label class="btn" style="cursor:pointer;" data-i18n="import">
                    Import
                    <input id="fileImport" type="file" accept="application/json" style="display:none;"/>
                </label>
                <label class="row hint" style="gap:6px;">
                    <input id="chkArchived" type="checkbox"/> <span data-i18n="showArchived">Toon gearchiveerden</span>
                </label>
            </div>
        </div>
    </header>

    <main class="container">
        <div id="empty" class="empty" style="display:none;">
            <h2 style="margin:0; font-size:18px; color: var(--fg);" data-i18n="emptyTitle">Nog geen plantjes</h2>
            <p class="muted" data-i18n="emptyText">Voeg je eerste plant toe en begin met tracken â€“ fotoâ€™s, weken, en herinneringen.</p>
            <button id="btnAdd2" data-i18n="newPlant">+ Nieuwe plant</button>
        </div>

        <div id="grid" class="grid"></div>

        <section id="archivedSection" style="display:none; margin-top:24px;">
            <div class="section-title" data-i18n="archivedTitle">Gearchiveerd</div>
            <div id="archivedGrid" class="grid archived"></div>
        </section>

        <footer class="muted" style="margin-top:24px; font-size:13px;" data-i18n="tipBackup">Tip: klik op "Export" om een back-up te maken. Je data wordt lokaal in je browser opgeslagen.</footer>
    </main>

    <script>
        // Taaldefinitie
        const TRANSLATIONS = {
            nl: {
                appName: "Autoflower Grow Assistant", newPlant: "+ Nieuwe plant", export: "Export", import: "Import", showArchived: "Toon gearchiveerden", tipBackup: 'Tip: klik op "Export" om een back-up te maken. Je data wordt lokaal in je browser opgeslagen.', emptyTitle: "Nog geen plantjes", emptyText: "Voeg je eerste plant toe en begin met tracken â€“ fotoâ€™s, weken, en herinneringen.", archivedTitle: "Gearchiveerd", plant: "Plant", archivedCycle: "Archiveer cyclus", unarchive: "Deblokkeren", delete: "Verwijderen", planted: "Geplant:", age: "Leeftijd:", weeks: "wk", days: "d", timeline: "Tijdlijn", reminders: "Herinneringen", notes: "Notities", date: "Datum:", noteOptional: "Opmerking (optioneel)", uploadPhoto: "Upload foto", noPhotos: "Nog geen foto's â€“ voeg je eerste Week 0 foto toe hierboven.", remove: "Verwijder", water: "ðŸ’§ Water", feed: "ðŸ¥¦ Voeding", startFlush: "ðŸ’¦ START FLUSH", week: "Week", every: "Elke", daysPlural: "dagen", startInWeek: "Start in week", frequency: "Frequentie: elke", flushStartWeek: "Flush starten in week", targetHarvestWeek: "Doel oogstweek", strainGuideline: "Soort Richtlijn:", adjustNote: "Pas frequentie aan op potmaat, substraat en klimaat.", exportCalendar: "Export .ics (kalender)", notesPlaceholder: "Notities over water, EC/PPM, pH, training, etc.", alertPhoto: "Kies eerst een foto.", alertDelete: "Verwijderen? Dit kan niet ongedaan worden gemaakt (alle foto's gaan mee).", alertMax: "Maximaal 12 plantjes ondersteund.", alertImport: "Kan bestand niet lezen:", darkMode: "Dark Mode"
            },
            en: {
                appName: "Autoflower Grow Assistant", newPlant: "+ New Plant", export: "Export", import: "Import", showArchived: "Show Archived", tipBackup: 'Tip: Click "Export" to make a backup. Your data is stored locally in your browser.', emptyTitle: "No Plants Yet", emptyText: "Add your first plant and start tracking â€“ photos, weeks, and reminders.", archivedTitle: "Archived", plant: "Plant", archivedCycle: "Archive Cycle", unarchive: "Unarchive", delete: "Delete", planted: "Planted:", age: "Age:", weeks: "wks", days: "d", timeline: "Timeline", reminders: "Reminders", notes: "Notes", date: "Date:", noteOptional: "Note (optional)", uploadPhoto: "Upload Photo", noPhotos: "No photos yet â€“ add your first Week 0 photo above.", remove: "Remove", water: "ðŸ’§ Water", feed: "ðŸ¥¦ Feed", startFlush: "ðŸ’¦ START FLUSH", week: "Week", every: "Every", daysPlural: "days", startInWeek: "Start in Week", frequency: "Frequency: every", flushStartWeek: "Start Flush in Week", targetHarvestWeek: "Target Harvest Week", strainGuideline: "Strain Guideline:", adjustNote: "Adjust frequency based on pot size, substrate, and climate.", exportCalendar: "Export .ics (calendar)", notesPlaceholder: "Notes on watering, EC/PPM, pH, training, etc.", alertPhoto: "Please select a photo first.", alertDelete: "Delete? This cannot be undone (all photos will be deleted).", alertMax: "Maximum of 12 plants supported.", alertImport: "Cannot read file:", darkMode: "Dark Mode"
            },
            de: {
                appName: "Autoflower Grow Assistant", newPlant: "+ Neue Pflanze", export: "Export", import: "Import", showArchived: "Archivierte anzeigen", tipBackup: 'Tipp: Klicken Sie auf "Exportieren", um ein Backup zu erstellen. Ihre Daten werden lokal im Browser gespeichert.', emptyTitle: "Noch keine Pflanzen", emptyText: "FÃ¼gen Sie Ihre erste Pflanze hinzu und beginnen Sie mit der Verfolgung â€“ Fotos, Wochen und Erinnerungen.", archivedTitle: "Archiviert", plant: "Pflanze", archivedCycle: "Zyklus archivieren", unarchive: "Wiederherstellen", delete: "LÃ¶schen", planted: "Gepflanzt:", age: "Alter:", weeks: "Wo", days: "T", timeline: "Zeitachse", reminders: "Erinnerungen", notes: "Notizen", date: "Datum:", noteOptional: "Notiz (optional)", uploadPhoto: "Foto hochladen", noPhotos: "Noch keine Fotos â€“ fÃ¼gen Sie Ihr erstes Foto der Woche 0 oben hinzu.", remove: "Entfernen", water: "ðŸ’§ Wasser", feed: "ðŸ¥¦ NÃ¤hrstoffe", startFlush: "ðŸ’¦ SPÃœLUNG STARTEN", week: "Woche", every: "Alle", daysPlural: "Tage", startInWeek: "Start in Woche", frequency: "Frequenz: alle", flushStartWeek: "SpÃ¼lung starten in Woche", targetHarvestWeek: "Ziel Erntewoche", strainGuideline: "Sortenrichtlinie:", adjustNote: "Passen Sie die HÃ¤ufigkeit an TopfgrÃ¶ÃŸe, Substrat und Klima an.", exportCalendar: ".ics exportieren (Kalender)", notesPlaceholder: "Notizen zu BewÃ¤sserung, EC/PPM, pH, Training, etc.", alertPhoto: "Bitte wÃ¤hlen Sie zuerst ein Foto aus.", alertDelete: "LÃ¶schen? Dies kann nicht rÃ¼ckgÃ¤ngig gemacht werden (alle Fotos werden gelÃ¶scht).", alertMax: "Maximal 12 Pflanzen werden unterstÃ¼tzt.", alertImport: "Datei kann nicht gelesen werden:", darkMode: "Dunkelmodus"
            },
            fr: {
                appName: "Assistant de Culture Autofloraison", newPlant: "+ Nouvelle Plante", export: "Exporter", import: "Importer", showArchived: "Afficher ArchivÃ©", tipBackup: 'Astuce : Cliquez sur "Exporter" pour crÃ©er une sauvegarde. Vos donnÃ©es sont stockÃ©es localement dans votre navigateur.', emptyTitle: "Pas encore de Plantes", emptyText: "Ajoutez votre premiÃ¨re plante et commencez le suivi â€“ photos, semaines et rappels.", archivedTitle: "ArchivÃ©", plant: "Plante", archivedCycle: "Archiver Cycle", unarchive: "DÃ©sarchiver", delete: "Supprimer", planted: "PlantÃ©(e):", age: "Ã‚ge:", weeks: "sem", days: "j", timeline: "Chronologie", reminders: "Rappels", notes: "Notes", date: "Date:", noteOptional: "Note (optionnel)", uploadPhoto: "TÃ©lÃ©charger photo", noPhotos: "Aucune photo pour l'instant â€“ ajoutez votre premiÃ¨re photo de la Semaine 0 ci-dessus.", remove: "Retirer", water: "ðŸ’§ Eau", feed: "ðŸ¥¦ Engrais", startFlush: "ðŸ’¦ DÃ‰BUT RINÃ‡AGE", week: "Semaine", every: "Tous les", daysPlural: "jours", startInWeek: "DÃ©but Semaine", frequency: "FrÃ©quence : tous les", flushStartWeek: "DÃ©but RinÃ§age Semaine", targetHarvestWeek: "Semaine de RÃ©colte Cible", strainGuideline: "Ligne directrice de la souche:", adjustNote: "Ajustez la frÃ©quence en fonction de la taille du pot, du substrat et du climat.", exportCalendar: "Exporter .ics (calendrier)", notesPlaceholder: "Notes sur l'arrosage, EC/PPM, pH, entraÃ®nement, etc.", alertPhoto: "Veuillez d'abord sÃ©lectionner une photo.", alertDelete: "Supprimer ? Ceci est irrÃ©versible (toutes les photos seront supprimÃ©es).", alertMax: "Maximum de 12 plantes prises en charge.", alertImport: "Impossible de lire le fichier :", darkMode: "Mode Sombre"
            },
            es: {
                appName: "Asistente de Cultivo Autofloreciente", newPlant: "+ Nueva Planta", export: "Exportar", import: "Importar", showArchived: "Mostrar Archivadas", tipBackup: 'Consejo: Haz clic en "Exportar" para hacer una copia de seguridad. Tus datos se guardan localmente en tu navegador.', emptyTitle: "TodavÃ­a no hay Plantas", emptyText: "Agrega tu primera planta y comienza a rastrear â€“ fotos, semanas y recordatorios.", archivedTitle: "Archivadas", plant: "Planta", archivedCycle: "Archivar Ciclo", unarchive: "Desarchivar", delete: "Eliminar", planted: "Plantada:", age: "Edad:", weeks: "sem", days: "d", timeline: "LÃ­nea de Tiempo", reminders: "Recordatorios", notes: "Notas", date: "Fecha:", noteOptional: "Nota (opcional)", uploadPhoto: "Subir foto", noPhotos: "AÃºn no hay fotos â€“ aÃ±ade tu primera foto de la Semana 0 arriba.", remove: "Quitar", water: "ðŸ’§ Agua", feed: "ðŸ¥¦ Nutrientes", startFlush: "ðŸ’¦ INICIAR LAVADO", week: "Semana", every: "Cada", daysPlural: "dÃ­as", startInWeek: "Iniciar Semana", frequency: "Frecuencia: cada", flushStartWeek: "Iniciar Lavado Semana", targetHarvestWeek: "Semana de Cosecha Objetivo", strainGuideline: "Pauta de la Cepa:", adjustNote: "Ajusta la frecuencia segÃºn el tamaÃ±o de la maceta, el sustrato y el clima.", exportCalendar: "Exportar .ics (calendario)", notesPlaceholder: "Notas sobre riego, EC/PPM, pH, entrenamiento, etc.", alertPhoto: "Por favor, selecciona una foto primero.", alertDelete: "Eliminar? Esto no se puede deshacer (se eliminarÃ¡n todas las fotos).", alertMax: "MÃ¡ximo de 12 plantas admitidas.", alertImport: "No se puede leer el archivo:", darkMode: "Modo Oscuro"
            }
        };

        // Staat voor taal en dark mode
        let currentLang = localStorage.getItem('appLang') || 'nl';
        let isDarkMode = localStorage.getItem('isDarkMode') === 'true';

        // Vertalingsfunctie
        // Opgeloste fout: Veranderd van 'const t = ...' naar een 'function t' om SyntaxError: Identifier 't' has already been declared te voorkomen in sommige omgevingen.
        function t(key) { 
            return TRANSLATIONS[currentLang]?.[key] || `[${key}]`; 
        }

        // Functie om de UI te vertalen
        function translateUI() {
            document.getElementById('appTitle').textContent = t('appName');
            document.getElementById('darkModeLabel').textContent = t('darkMode');

            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                // Speciale behandeling voor de import label, om de input te behouden
                if (key === 'import') {
                    const input = el.querySelector('input');
                    el.textContent = t(key);
                    if (input) el.appendChild(input); 
                } else {
                    el.textContent = t(key);
                }
            });
            
            // Handmatige vertaling van dynamic content in de main body
            render();
        }
        
        // Functie om dark mode toe te passen
        function setDarkMode(enabled) {
            isDarkMode = enabled;
            document.body.classList.toggle('dark', enabled);
            document.getElementById('darkModeToggle').checked = enabled;
            localStorage.setItem('isDarkMode', enabled);
        }


        // ===== Initialisatie Taal en Dark Mode =====
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('langSelect').value = currentLang;
            document.getElementById('langSelect').onchange = (e) => {
                currentLang = e.target.value;
                localStorage.setItem('appLang', currentLang);
                translateUI();
            };
            
            // Dark Mode Listener
            document.getElementById('darkModeToggle').onchange = (e) => {
                setDarkMode(e.target.checked);
            };

            // Pas initiÃ«le dark mode toe
            setDarkMode(isDarkMode);
            // Vertaal de UI na het laden van alle elementen
            translateUI();
        });


        // ===== Utilities & RQS STRAIN DATA (Aangepast met i18n) =====
        const uid = () => Math.random().toString(36).slice(2,10);
        const todayISO = () => new Date().toISOString().slice(0,10);
        const toISODate = d => new Date(d).toISOString().slice(0,10);
        const fmtDate = d => new Date(d).toLocaleDateString(currentLang); // Gebruik huidige taal
        const fmtShortDate = () => new Date().toLocaleDateString(currentLang, { day: 'numeric', month: 'short' });
        
        const daysBetween = (a,b) => Math.floor((new Date(b) - new Date(a)) / 86400000);
        const weekNumberSince = (start, at) => Math.floor(daysBetween(start, at) / 7);
        const addDays = (date, days)=>{ const d = new Date(date); d.setDate(d.getDate()+days); return d; };
        const setHourMin = (date,h,m)=>{ const d = new Date(date); d.setHours(h,m,0,0); return d; };
        const escapeICS = (s)=>{ return String(s).replace(/\\/g,'\\\\').replace(/\n/g,'\\n').replace(/,/g,'\\,').replace(/;/g,'\\;'); };

        const RQS_STRAINS = {
            'Quick One (RQS)': {
                type: 'Autoflower (Indica)',
                hint: { nl:'Cyclus: 8â€“9 weken totaal. Typische autoflower planning.', en:'Cycle: 8â€“9 weeks total. Typical autoflower schedule.', de:'Zyklus: 8â€“9 Wochen total. Typischer Autoflower-Zeitplan.', fr:'Cycle: 8â€“9 semaines au total. Programme autoflo typique.', es:'Ciclo: 8â€“9 semanas totales. Horario tÃ­pico de autofloreciente.' },
                schedule: { waterEveryDays:2, feedStartWeek:3, feedEveryDays:7, flushStartWeek:8, targetHarvestWeek:9 }
            },
            'Royal Dwarf (RQS)': {
                type: 'Autoflower (Dwarf)',
                hint: { nl:'Cyclus: 9â€“10 weken totaal. Kan wat langer bloeien dan Quick One.', en:'Cycle: 9â€“10 weeks total. May flower slightly longer than Quick One.', de:'Zyklus: 9â€“10 Wochen total. Kann etwas lÃ¤nger blÃ¼hen als Quick One.', fr:'Cycle: 9â€“10 semaines au total. Peut fleurir un peu plus longtemps que Quick One.', es:'Ciclo: 9â€“10 semanas totales. Puede florecer un poco mÃ¡s que Quick One.' },
                schedule: { waterEveryDays:3, feedStartWeek:3, feedEveryDays:7, flushStartWeek:9, targetHarvestWeek:10 }
            },
            'Northern Light Auto (RQS)': {
                type: 'Autoflower (Sterke Indica)',
                hint: { nl:'Cyclus: 10â€“12 weken totaal. Vraagt mogelijk meer voeding in de bloei.', en:'Cycle: 10â€“12 weeks total. May require more nutrients during flowering.', de:'Zyklus: 10â€“12 Wochen total. BenÃ¶tigt mÃ¶glicherweise mehr NÃ¤hrstoffe wÃ¤hrend der BlÃ¼te.', fr:'Cycle: 10â€“12 semaines au total. Peut nÃ©cessiter plus d\'engrais pendant la floraison.', es:'Ciclo: 10â€“12 semanas totales. Puede requerir mÃ¡s nutrientes durante la floraciÃ³n.' },
                schedule: { waterEveryDays:2, feedStartWeek:4, feedEveryDays:5, flushStartWeek:10, targetHarvestWeek:12 }
            },
            'Shining Silver Haze (RQS)': {
                type: 'Feminized (Sativa)',
                hint: { nl:'Groeit lang door, afhankelijk van wanneer je de klok omzet naar 12/12. Bloeitijd 9â€“11 weken.', en:'Grows tall, depending on when you switch to 12/12. Flowering time 9â€“11 weeks.', de:'WÃ¤chst hoch, je nachdem, wann Sie auf 12/12 umstellen. BlÃ¼tezeit 9â€“11 Wochen.', fr:'Pousse haut, selon le moment oÃ¹ vous passez Ã  12/12. Temps de floraison 9â€“11 semaines.', es:'Crece alta, dependiendo de cuÃ¡ndo cambies a 12/12. Tiempo de floraciÃ³n 9â€“11 semanas.' },
                schedule: { waterEveryDays:3, feedStartWeek:1, feedEveryDays:7, flushStartWeek:15, targetHarvestWeek:17 } 
            },
            'Fat Banana (RQS)': {
                type: 'Feminized (Indica)',
                hint: { nl:'Bloeitijd 7â€“9 weken. Snelle bloeier met stevige voedingseisen.', en:'Flowering time 7â€“9 weeks. Fast flowerer with strong nutrient demands.', de:'BlÃ¼tezeit 7â€“9 Wochen. Schnelle BlÃ¼herin mit hohem NÃ¤hrstoffbedarf.', fr:'Temps de floraison 7â€“9 semaines. Floraison rapide avec de fortes exigences en nutriments.', es:'Tiempo de floraciÃ³n 7â€“9 semanas. FloraciÃ³n rÃ¡pida con altas demandas de nutrientes.' },
                schedule: { waterEveryDays:2, feedStartWeek:1, feedEveryDays:5, flushStartWeek:11, targetHarvestWeek:13 } 
            },
            'Onbekend/Algemeen': {
                type: 'Gemiddeld/Algemeen',
                hint: { nl:'Gebaseerd op een algemene autoflower-cyclus van 10 weken. Pas dit aan op je soort!', en:'Based on a general 10-week autoflower cycle. Adjust this according to your strain!', de:'Basiert auf einem allgemeinen 10-wÃ¶chigen Autoflower-Zyklus. Passen Sie dies an Ihre Sorte an!', fr:'BasÃ© sur un cycle autoflo gÃ©nÃ©ral de 10 semaines. Ajustez ceci en fonction de votre souche!', es:'Basado en un ciclo autofloreciente general de 10 semanas. Â¡Ajusta esto segÃºn tu cepa!' },
                schedule: { waterEveryDays:2, feedStartWeek:2, feedEveryDays:7, flushStartWeek:9, targetHarvestWeek:10 }
            }
        };

        // De hints in de render functie gebruiken nu de huidige taal:
        const getStrainHint = (strainKey) => RQS_STRAINS[strainKey]?.hint?.[currentLang] || RQS_STRAINS['Onbekend/Algemeen'].hint[currentLang];


        // ===== Persistence & State Management (Ongewijzigd) =====
        const LS_KEY = 'quickone_grow_tracker_v1_html';
        
        let state = { plants:[], viewArchived:false, actionsCompletedToday: { date: todayISO(), completed: [] } };
        
        const loadState = () => { 
            try { 
                const raw = localStorage.getItem(LS_KEY); 
                const loadedState = raw ? JSON.parse(raw) : null; 
                
                if (loadedState) {
                    if (loadedState.actionsCompletedToday && loadedState.actionsCompletedToday.date === todayISO()) {
                        state = loadedState;
                    } else {
                        state.plants = loadedState.plants || [];
                        state.viewArchived = loadedState.viewArchived || false;
                        saveState(state);
                    }
                }
            } catch(e){ 
                console.warn(e); 
            } 
        };
        
        const saveState = (s) => { 
            try { 
                localStorage.setItem(LS_KEY, JSON.stringify(s)); 
            } catch(e){ 
                console.warn(e); 
            } 
        };

        function completeAction(plantId, actionType) {
            const actionKey = `${plantId}-${actionType}`;
            if (!state.actionsCompletedToday.completed.includes(actionKey)) {
                state.actionsCompletedToday.completed.push(actionKey);
                saveAndRender();
            }
        }
        
        loadState(); 
        
        // ===== Core Logic (Aangepast met i18n) =====
        const grid = document.getElementById('grid');
        const archivedGrid = document.getElementById('archivedGrid');
        const empty = document.getElementById('empty');
        const archivedSection = document.getElementById('archivedSection');
        const chkArchived = document.getElementById('chkArchived');

        document.getElementById('btnAdd').onclick = addPlant;
        document.getElementById('btnAdd2').onclick = addPlant;
        document.getElementById('btnExport').onclick = exportJSON;
        document.getElementById('fileImport').onchange = (e)=> e.target.files?.[0] && importJSON(e.target.files[0]);
        chkArchived.onchange = (e)=>{ state.viewArchived = e.target.checked; saveAndRender(); };

        function addPlant(){
            if(state.plants.length >= 12){ alert(t('alertMax')); return; }
            const d = todayISO();
            const initialStrain = 'Quick One (RQS)';
            state.plants.unshift({ 
                id:uid(), 
                name:`${t('plant')} ${state.plants.length+1}`, // Plantnaam in huidige taal
                strain: initialStrain, 
                plantedDate:d, 
                archived:false, 
                notes:'', 
                schedule:{...RQS_STRAINS[initialStrain].schedule}, 
                photos:[] 
            });
            saveAndRender();
        }

        function updatePlant(id, patch){
            state.plants = state.plants.map(p=> p.id===id? {...p, ...patch}: p);
            saveAndRender();
        }
        function removePlant(id){
            if(!confirm(t('alertDelete'))) return;
            state.plants = state.plants.filter(p=> p.id!==id);
            saveAndRender();
        }
        function saveAndRender(){ saveState(state); render(); }

        function exportJSON(){
            const { actionsCompletedToday, ...exportState } = state; 
            const blob = new Blob([JSON.stringify(exportState,null,2)], {type:'application/json'});
            const url = URL.createObjectURL(blob);
            const a = Object.assign(document.createElement('a'), { href:url, download:`quickone-tracker-${todayISO()}.json`});
            a.click(); URL.revokeObjectURL(url);
        }
        function importJSON(file){
            const r = new FileReader();
            r.onload = ()=>{ 
                try{ 
                    const parsed = JSON.parse(r.result); 
                    if(!parsed?.plants) throw new Error('Ongeldig bestand'); 
                    
                    state.plants = parsed.plants;
                    state.viewArchived = parsed.viewArchived || false;
                    
                    chkArchived.checked = !!state.viewArchived; 
                    saveAndRender(); 
                }catch(e){ 
                    alert(`${t('alertImport')} ${e.message}`); 
                } 
            };
            r.readAsText(file);
        }

        function fileToDataURL(file){ return new Promise((res,rej)=>{ const r = new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }


        // ===== ACTIE BEREKENING LOGICA (Aangepast met i18n) =====
        function getPlantActions(plant) {
            if (plant.archived) return [];

            const daysSincePlanting = daysBetween(plant.plantedDate, todayISO());
            const weeksSincePlanting = weekNumberSince(plant.plantedDate, todayISO());
            const { waterEveryDays, feedStartWeek, feedEveryDays, flushStartWeek } = plant.schedule;
            const actions = [];
            const actionDate = fmtShortDate();

            // 1. Water geven
            if (daysSincePlanting % waterEveryDays === 0) {
                actions.push({ 
                    type: 'water', 
                    label: `${t('water')} (${actionDate})`, 
                    css: 'water' 
                });
            }

            // 2. Voeding
            if (weeksSincePlanting >= feedStartWeek) {
                if (daysSincePlanting % feedEveryDays === 0) {
                    actions.push({ 
                        type: 'feed', 
                        label: `${t('feed')} (${actionDate})`, 
                        css: 'feed' 
                    });
                }
            }

            // 3. Flush
            if (weeksSincePlanting >= flushStartWeek) {
                 if (weeksSincePlanting === flushStartWeek && daysBetween(plant.plantedDate, todayISO()) % 7 < 3) {
                    actions.push({ 
                        type: 'flush', 
                        label: `${t('startFlush')} (${actionDate})`, 
                        css: 'flush' 
                    });
                 }
            }
            
            return actions.filter(action => {
                const actionKey = `${plant.id}-${action.type}`;
                return !state.actionsCompletedToday.completed.includes(actionKey);
            });
        }


        // ===== Rendering (Aangepast met i18n) =====
        function render(){
            loadState(); 
            
            const active = state.plants.filter(p=>!p.archived);
            const archived = state.plants.filter(p=>p.archived);

            empty.style.display = active.length? 'none':'block';
            grid.innerHTML = '';
            active.forEach(p=> grid.appendChild(renderPlantCard(p)) );

            archivedSection.style.display = state.viewArchived && archived.length? 'block':'none';
            archivedGrid.innerHTML = '';
            if(state.viewArchived){ archived.forEach(p=> archivedGrid.appendChild(renderPlantCard(p)) ); }
        }

        function renderPlantCard(plant){
            const card = document.createElement('div');
            card.className = 'card';
            const actions = getPlantActions(plant);

            const h = document.createElement('div'); h.className = 'card-h';
            const left = document.createElement('div'); left.className='grow-1';

            // 1. Plantnaam Invoer
            const row1 = document.createElement('div'); row1.className='row-name'; 
            const nameInput = Object.assign(document.createElement('input'), { value: plant.name, type:'text' });
            nameInput.style.fontSize='16px'; nameInput.style.fontWeight='600'; nameInput.style.border='none'; nameInput.style.outline='none';
            nameInput.oninput = (e)=> updatePlant(plant.id, { name:e.target.value });
            row1.append(nameInput);
            
            // 2. Soort Keuze Dropdown
            const rowStrain = document.createElement('div'); rowStrain.className='row-strain';
            const strainSelect = document.createElement('select');
            for (const [key, value] of Object.entries(RQS_STRAINS)) {
                const option = Object.assign(document.createElement('option'), { value: key, text: key });
                strainSelect.appendChild(option);
            }
            strainSelect.value = plant.strain; 
            strainSelect.onchange = (e) => {
                const newStrain = e.target.value;
                const newSchedule = RQS_STRAINS[newStrain].schedule;
                updatePlant(plant.id, { strain: newStrain, schedule: newSchedule });
            };
            
            const strainType = document.createElement('span'); 
            strainType.className='pill'; 
            strainType.textContent = RQS_STRAINS[plant.strain]?.type || t('onbekend'); 
            rowStrain.append(strainSelect, strainType);

            // 3. Datum & Leeftijd & Acties
            const rowInfo = document.createElement('div'); rowInfo.className='row-info';

            // Geplant datum
            const plantedLbl = document.createElement('label'); 
            plantedLbl.textContent = t('planted');
            const dateInput = Object.assign(document.createElement('input'), { type:'date', value: toISODate(plant.plantedDate) });
            dateInput.onchange = (e)=> updatePlant(plant.id, { plantedDate: e.target.value });
            plantedLbl.appendChild(dateInput);

            // Leeftijd
            const ageDays = daysBetween(plant.plantedDate, new Date());
            const ageWeeks = Math.floor(ageDays/7);
            const age = document.createElement('span'); 
            age.textContent = `${t('age')} ${ageWeeks} ${t('weeks')} (${ageDays} ${t('days')})`;

            // Knoppen groep
            const actionButtons = document.createElement('div'); actionButtons.className = 'action-buttons';
            const archiveBtn = document.createElement('button'); archiveBtn.className='btn'; 
            archiveBtn.textContent = plant.archived? t('unarchive') : t('archivedCycle');
            archiveBtn.onclick = ()=> updatePlant(plant.id, { archived: !plant.archived });

            const delBtn = document.createElement('button'); delBtn.className='btn danger'; delBtn.textContent=t('delete'); 
            delBtn.onclick = ()=> removePlant(plant.id);
            actionButtons.append(archiveBtn, delBtn);

            rowInfo.append(plantedLbl, age, actionButtons);

            left.append(row1, rowStrain, rowInfo); 
            h.appendChild(left); 

            // 4. Action Items Bar
            if (actions.length > 0) {
                const actionsBar = document.createElement('div');
                actionsBar.className = 'actions-bar';
                
                actions.forEach(action => {
                    const actionItem = document.createElement('button');
                    actionItem.className = `action-item ${action.css}`;
                    actionItem.textContent = action.label;
                    actionItem.onclick = () => completeAction(plant.id, action.type);
                    actionsBar.appendChild(actionItem);
                });
                h.appendChild(actionsBar);
            }

            // 5. Tabs
            const tabs = document.createElement('div'); tabs.className='tabs';
            const tabTimeline = document.createElement('button'); tabTimeline.className='tab active'; tabTimeline.textContent=t('timeline');
            const tabSchedule = document.createElement('button'); tabSchedule.className='tab'; tabSchedule.textContent=t('reminders');
            const tabNotes = document.createElement('button'); tabNotes.className='tab'; tabNotes.textContent=t('notes');
            tabs.append(tabTimeline, tabSchedule, tabNotes);

            h.append(tabs); card.appendChild(h);

            const bodyTimeline = document.createElement('div'); bodyTimeline.className='card-b';
            const bodySchedule = document.createElement('div'); bodySchedule.className='card-b'; bodySchedule.style.display='none';
            const bodyNotes = document.createElement('div'); bodyNotes.className='card-b'; bodyNotes.style.display='none';

            // Uploader
            const uploader = document.createElement('div'); uploader.className='uploader';
            const file = Object.assign(document.createElement('input'), { type:'file', accept:'image/*' }); 
            const dLbl = document.createElement('label'); dLbl.className='muted'; dLbl.textContent=t('date'); dLbl.textContent += ': ';
            const dIn = Object.assign(document.createElement('input'), {type:'date', value: todayISO()});
            dLbl.appendChild(dIn);
            const note = Object.assign(document.createElement('input'), {type:'text', placeholder:t('noteOptional')});
            note.style.minWidth = '180px'; note.style.flex='1';
            const weekSpan = document.createElement('span'); weekSpan.className='muted'; weekSpan.style.fontSize='12px'; weekSpan.textContent = weekLabel(plant.plantedDate, dIn.value);
            dIn.onchange = ()=> weekSpan.textContent = weekLabel(plant.plantedDate, dIn.value);
            const upBtn = document.createElement('button'); upBtn.textContent=t('uploadPhoto');
            upBtn.onclick = async()=>{
                if(!file.files[0]) return alert(t('alertPhoto'));
                const dataURL = await fileToDataURL(file.files[0]);
                const photo = { id:uid(), dataURL, date:dIn.value || todayISO(), note: note.value || '' };
                const photos = [...plant.photos, photo].sort((a,b)=> new Date(a.date)-new Date(b.date));
                updatePlant(plant.id, { photos }); file.value=''; note.value=''; dIn.value = todayISO(); weekSpan.textContent = weekLabel(plant.plantedDate, dIn.value);
            };
            uploader.append(file, dLbl, note, weekSpan, upBtn);
            bodyTimeline.appendChild(uploader);

            // Galerij
            const gallery = document.createElement('div'); gallery.style.marginTop='12px'; gallery.style.display='grid'; gallery.style.gridTemplateColumns='1fr'; gallery.style.gap='12px';
            if(plant.photos.length===0){
                const p = document.createElement('div'); p.className='muted'; p.textContent = t('noPhotos'); gallery.appendChild(p);
            }
            plant.photos.sort((a,b)=> new Date(a.date)-new Date(b.date)).forEach(ph=>{
                const fig = document.createElement('figure');
                const img = Object.assign(document.createElement('img'), { src: ph.dataURL, alt:t('plant') });
                const cap = document.createElement('figcaption');
                const left = document.createElement('div');
                const title = document.createElement('div'); title.style.fontWeight='600'; 
                title.textContent = `${plant.name} â€“ ${fmtDate(ph.date)} (${t('week')} ${weekNumberSince(plant.plantedDate, ph.date)})`;
                const sub = document.createElement('div'); sub.className='muted'; sub.textContent = ph.note || '';
                left.append(title, sub);
                const del = document.createElement('button'); del.className='btn danger'; del.textContent=t('remove'); del.onclick=()=>{
                    const photos = plant.photos.filter(x=> x.id!==ph.id); updatePlant(plant.id, { photos });
                };
                cap.append(left, del); fig.append(img, cap); gallery.appendChild(fig);
            });
            bodyTimeline.appendChild(gallery);

            // Schedule Body met Mooie Uitlijning
            const s = plant.schedule;
            const strainHint = getStrainHint(plant.strain);
            bodySchedule.innerHTML = `
                <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px;">
                    <div>
                        <div class="section-title">${t('water')}</div>
                        <div class="field-group">
                            <span>${t('every')}</span>
                            <input id="wEvery-${plant.id}" type="number" min="1" value="${s.waterEveryDays}">
                            <span>${t('daysPlural')}</span>
                        </div>
                    </div>
                    <div>
                        <div class="section-title">${t('feed')}</div>
                        <div class="field-group">
                            <span>${t('startInWeek')}</span>
                            <input id="fStart-${plant.id}" type="number" min="0" value="${s.feedStartWeek}">
                        </div>
                        <div class="field-group">
                            <span>${t('frequency')}</span>
                            <input id="fEvery-${plant.id}" type="number" min="1" value="${s.feedEveryDays}">
                            <span>${t('daysPlural')}</span>
                        </div>
                    </div>
                    <div>
                        <div class="section-title">${t('flushStartWeek')} & ${t('targetHarvestWeek')}</div>
                        <div class="field-group">
                            <span>${t('flushStartWeek')}</span>
                            <input id="flStart-${plant.id}" type="number" min="0" value="${s.flushStartWeek}">
                        </div>
                        <div class="field-group">
                            <span>${t('targetHarvestWeek')}</span>
                            <input id="harv-${plant.id}" type="number" min="0" value="${s.targetHarvestWeek}">
                        </div>
                    </div>
                    <div class="muted" style="font-size:14px; align-self:start;">
                        <strong>${t('strainGuideline')}</strong> ${strainHint}
                        <br><br>
                        ${t('adjustNote')}
                    </div>
                </div>
                <div class="row" style="gap:8px; margin-top:12px; flex-wrap:wrap;">
                    <button id="btnICS-${plant.id}" class="btn">${t('exportCalendar')}</button>
                </div>`;

            // Inputs koppelen
            setTimeout(()=>{
                const clamp = (n,min)=> Math.max(min, Number(n||min));
                document.getElementById(`wEvery-${plant.id}`).oninput = (e)=> updatePlant(plant.id, { schedule:{...plant.schedule, waterEveryDays: clamp(e.target.value,1)} });
                document.getElementById(`fStart-${plant.id}`).oninput = (e)=> updatePlant(plant.id, { schedule:{...plant.schedule, feedStartWeek: clamp(e.target.value,0)} });
                document.getElementById(`fEvery-${plant.id}`).oninput = (e)=> updatePlant(plant.id, { schedule:{...plant.schedule, feedEveryDays: clamp(e.target.value,1)} });
                document.getElementById(`flStart-${plant.id}`).oninput = (e)=> updatePlant(plant.id, { schedule:{...plant.schedule, flushStartWeek: clamp(e.target.value,0)} });
                document.getElementById(`harv-${plant.id}`).oninput = (e)=> updatePlant(plant.id, { schedule:{...plant.schedule, targetHarvestWeek: clamp(e.target.value,0)} });
                document.getElementById(`btnICS-${plant.id}`).onclick = ()=> exportICS(plant);
            });

            // Notities
            const ta = document.createElement('textarea'); ta.placeholder=t('notesPlaceholder'); ta.value = plant.notes || ''; ta.style.width='100%'; ta.style.minHeight='120px';
            ta.oninput = (e)=> updatePlant(plant.id, { notes:e.target.value });
            bodyNotes.appendChild(ta);

            // Tabs functionaliteit
            tabTimeline.onclick = ()=> { tabTimeline.classList.add('active'); tabSchedule.classList.remove('active'); tabNotes.classList.remove('active'); bodyTimeline.style.display='block'; bodySchedule.style.display='none'; bodyNotes.style.display='none'; };
            tabSchedule.onclick = ()=> { tabSchedule.classList.add('active'); tabTimeline.classList.remove('active'); tabNotes.classList.remove('active'); bodyTimeline.style.display='none'; bodySchedule.style.display='block'; bodyNotes.style.display='none'; };
            tabNotes.onclick = ()=> { tabNotes.classList.add('active'); tabTimeline.classList.remove('active'); tabSchedule.classList.remove('active'); bodyTimeline.style.display='none'; bodySchedule.style.display='none'; bodyNotes.style.display='block'; };

            card.append(bodyTimeline, bodySchedule, bodyNotes);
            return card;

            function weekLabel(start, at){ return `${t('week')} ${weekNumberSince(start, at)}`; }
        }

        // ICS Export (Ongewijzigd)
        function exportICS(plant){
            const { plantedDate, schedule } = plant;
            const planted = new Date(plantedDate);
            const events = [];
            const dt = (d)=>{
                const pad = n=> String(n).padStart(2,'0');
                return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}T${pad(d.getHours())}${pad(d.getMinutes())}00`;
            };
            const vEvent = ({ summary, start, durationMin=30, description='' })=>{
                const end = new Date(start.getTime()+durationMin*60000);
                return [
                    'BEGIN:VEVENT',
                    `UID:${uid()}@quickone}`,
                    `DTSTAMP:${dt(new Date())}`,
                    `DTSTART:${dt(start)}`,
                    `DTEND:${dt(end)}`,
                    `SUMMARY:${escapeICS(summary)}`,
                    description? `DESCRIPTION:${escapeICS(description)}`: null,
                    'END:VEVENT',
                ].filter(Boolean).join('\r\n');
            };

            const harvestDate = addDays(planted, schedule.targetHarvestWeek*7);
            for(let d=new Date(planted); d<=harvestDate; d=addDays(d, schedule.waterEveryDays)){
                const start = setHourMin(d, 9, 0);
                events.push(vEvent({ summary:`${t('water')} â€“ ${plant.name}`, start, durationMin:15 }));
            }
            const feedStart = addDays(planted, schedule.feedStartWeek*7);
            for(let d=new Date(feedStart); d<=harvestDate; d=addDays(d, schedule.feedEveryDays)){
                const start = setHourMin(d, 10, 0);
                events.push(vEvent({ summary:`${t('feed')} â€“ ${plant.name}`, start, durationMin:20, description:t('notesPlaceholder') }));
            }
            const flushStart = addDays(planted, schedule.flushStartWeek*7);
            events.push(vEvent({ summary:`${t('startFlush')} â€“ ${plant.name}`, start:setHourMin(flushStart,9,0), durationMin:30 }));
            const harv = addDays(planted, schedule.targetHarvestWeek*7);
            events.push(vEvent({ summary:`${t('targetHarvestWeek')} â€“ ${plant.name}`, start:setHourMin(harv,11,0), durationMin:60, description:t('adjustNote') }));

            const ics = ['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//QuickOne Tracker HTML//NL', ...events, 'END:VCALENDAR'].join('\r\n');
            const blob = new Blob([ics], {type:'text/calendar;charset=utf-8'});
            const a = Object.assign(document.createElement('a'), { href: URL.createObjectURL(blob), download: `${plant.name.replace(/\s+/g,'-')}-reminders.ics`});
            a.click(); setTimeout(()=> URL.revokeObjectURL(a.href), 0);
        }

        chkArchived.checked = !!state.viewArchived;
        
    </script>
</body>
</html>
